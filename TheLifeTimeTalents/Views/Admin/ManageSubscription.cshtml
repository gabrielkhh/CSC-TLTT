@{
    ViewData["Title"] = "Admin";
}

<div class="container body-content">
    <h2>@ViewData["Title"].</h2>


    <h4>Subscription plan data</h4>
    <hr />

    <form id="myForm" data-toggle="validator">
        <div class="row">
            <div class="form-group">
                <label class="col-md-2 control-label">Plan Id</label>
                <div class="col-md-2">
                    <input type="text" id="txtPlanId" name="txtPlanId" class="form-control" />
                </div>
            </div>
        </div>

        <br /><br />

        <div class="row">
            <div class="form-group">
                <label class="col-md-2 control-label">Plan Name</label>
                <div class="col-md-10">
                    <text id="txtPlanName"></text>
                </div>
            </div>
        </div>

        <br /><br />

        <div class="row">
            <div class="form-group">
                <label class="col-md-2 control-label">Plan Price</label>
                <div class="col-md-10">
                    <text id="txtPlanPrice"></text>
                </div>
            </div>
        </div>


        <div class="form-group">
            <div class="col-md-offset-2 col-md-10 padding-top-more padding-bottom">
                <button id="btnUpdate" type="submit" class="btn btn-default">Update</button>
            </div>
        </div>
    </form>
</div>

<script>
    var idToken = sessionStorage.getItem('idToken');

    var localPlanId = "";

    loadPlanData();

    function loadPlanData() {

        loadPlanDataHandler = jQuery.ajax({
            method: 'GET',
            url: 'http://server.anythingabout.me/API/Subscription/GetPlanInformation',
            crossDomain: true,
            dataType: 'json',
            cache: false,
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'bearer ' + idToken)
            }
        })
        loadPlanDataHandler.done(function (data, textStatus, jqXHR) {

            console.log(data);

            var planId = data.planStripeId;
            var planName = data.planName;
            var planPrice = data.planAmount;
            var planCurrency = data.planCurrency;
            var planInterval = data.planInterval;
            localPlanId = data.localPlanId;

            var roundedPlanPrice = (planPrice / 100).toFixed(2);

            

            $('#txtPlanId').val(planId);
            $('#txtPlanName').text(planName);
            $('#txtPlanPrice').text(planCurrency.toUpperCase() + " $" + roundedPlanPrice + "/" + planInterval);

        })
        loadPlanDataHandler.fail(function (data, textStatus, jqXHR) {
            toastr.options = {
                "closeButton": false,
                "debug": false,
                "newestOnTop": false,
                "progressBar": false,
                "positionClass": "toast-bottom-left",
                "preventDuplicates": false,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "5000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            }
            toastr["error"]("There was an issue retrieving data from the server.", "Error")
        })
    }

    $(document).ready(function () {

        $("#btnUpdate").click(function () {

            event.preventDefault();

            swal({
                title: "Update Subscription Plan?",
                showCancelButton: true,
                closeOnConfirm: false,
                confirmButtonText: "Yes",
                cancelButtonText: "No",
                confirmButtonColor: "#F05F40",
                showLoaderOnConfirm: true,
            },
                function () {

                    function WebFormData(inPlanId, inLocalPlanId) {
                        this.planId = inPlanId;
                        this.localPlanId = inLocalPlanId;
                    }

                    collectedPlanId = $('#txtPlanId').val();

                    var webFormData = new WebFormData(collectedPlanId, localPlanId);

                    var webFormDataInString = JSON.stringify(webFormData);

                    console.log(webFormDataInString);

                    $saveHandler = jQuery.ajax({
                        type: 'PUT',
                        url: 'http://server.anythingabout.me/API/Subscription/EditPlan',
                        crossDomain: true,
                        data: webFormDataInString,
                        dataType: 'json',
                        contentType: 'application/json',
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('Authorization', 'bearer ' + idToken)
                        }
                    });

                    $saveHandler.done(function (data, textStatus, jqXHR) {
                        swal({
                            title: "Successful!",
                            text: "Subscription Fee Updated!",
                            type: "success",
                            confirmButtonColor: "#F05F40",
                        },
                            function () {
                                ignore = true;
                                window.location.replace("/Admin/ManageSubscription");
                            });
                    });

                    $saveHandler.fail(function (data, textStatus, jqXHR) {
                        swal({
                            title: "Error!",
                            text: "Update Subscription Plan fail!",
                            type: "error",
                            confirmButtonColor: "#F05F40",
                        });
                    });
                });
        });
    });
</script>